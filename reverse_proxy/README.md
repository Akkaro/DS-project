# Reverse Proxy — Energy Management System

A Traefik reverse proxy that acts as the single entry point (API Gateway) for the Energy Management System. It routes incoming requests to the appropriate microservice (`auth`, `user`, `device`) or the `frontend` application based on the URL path.

## Overview

This component uses Traefik to manage all web traffic. It exposes a single port (`8000`) to the host machine and intelligently forwards requests to the correct internal Docker container. It is responsible for path-based routing, stripping URL prefixes, and monitoring the health of backend services.

## Project Structure

```
reverse_proxy/
├── dynamic/
│   └── path.yml         # Dynamic routing rules, middlewares, & services
├── logs/
│   └── access.log       # Live access logs from Traefik
├── traefik.yml          # Static configuration (entrypoints, dashboard, logging)
└── README.MD            # This file (The old README was README.MD)
```

## Features

  - **Path-Based Routing**: Maps public paths like `/api/users` to the correct internal microservice.
  - **Middleware**: Uses the `stripPrefix` middleware to remove `/api` from paths before forwarding them to microservices.
  - **Monitoring Dashboard**: Provides a built-in web dashboard to visualize routes, services, and health checks.
  - **Health Checks**: Actively monitors the `/actuator/health` endpoint of backend services to ensure they are online before forwarding traffic.
  - **Centralized Logging**: Captures all incoming web requests in `access.log` for debugging.

## Core Components

The Traefik configuration is split into two main files:

  - **`traefik.yml` (Static Config)**: Defines the proxy's startup configuration. This includes setting up entry points (like `web` on port `:80`), enabling the API dashboard, and specifying the file provider to read dynamic rules.
  - **`dynamic/path.yml` (Dynamic Config)**: Defines the "routers" (the rules that match requests) and "services" (the backend containers). This file is "hot-reloaded," meaning Traefik can apply changes without a restart.

## Prerequisites

  - **Docker**
  - **Docker Compose**

## Configuration (Service Definition)

The Traefik service is defined within the main `docker-compose.yml` file. This configuration maps ports, mounts configuration volumes, and connects it to the Docker socket.

```yaml
# From docker-compose.yml
services:
  # ... (other services) ...
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: always
    ports:
      - "8000:80"      # HTTP entrypoint
      - "8081:8080"  # Optional dashboard
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./reverse_proxy/traefik.yml:/etc/traefik/traefik.yml:ro"
      - "./reverse_proxy/dynamic:/etc/traefik/dynamic:ro"
      - "./reverse_proxy/logs:/var/log/traefik"
    depends_on:
      - user-service
      - device-service
      - auth-service
      - frontend
    networks:
      - ems-network
```

## How to Run

This service is not intended to be run standalone. It is started as part of the entire application stack using the main `docker-compose.yml`.

```bash
# From the project root
docker compose up -d
```

  - The application will be accessible at **http://localhost:8000**.
  - The Traefik dashboard will be accessible at **http://localhost:8081**.

## Routing Rules

Traefik routes traffic as follows:

| External Path (via `localhost:8000`) | Target Service | Internal URL | Middleware |
|---|---|---|---|
| `/` | `frontend` | `http://frontend:80` | None |
| `/api/auth/*` | `auth-service` | `http://auth-service:8082` | None |
| `/api/users/*` | `user-service` | `http://user-service:8080` | `strip-api-prefix` |
| `/api/devices/*` | `device-service` | `http://device-service:8080` | `strip-api-prefix` |

## Error Responses

Traefik is responsible for gateway-level errors. If you see these, it typically means a backend microservice is unhealthy or misconfigured:

  - `502 Bad Gateway`: The service is down or unreachable.
  - `504 Gateway Timeout`: The service took too long to respond.

Application-level errors (like `400 Bad Request`, `401 Unauthorized`, `404 Not Found`) are generated by the microservices themselves and are passed through the proxy to the client.

## Security Notes

  - **Single Entry Point**: The proxy is the only service that exposes ports to the host machine. All microservices (`user-db`, `auth-service`, etc.) are only accessible *within* the private Docker network (`ems-network`).
  - **Future Enhancements**: Traefik can be easily configured to handle SSL (HTTPS), automatic certificates, rate limiting, and more complex authentication middlewares.

## Integration with Other Microservices

This proxy is the central hub and integrates with all other services:

  - **`frontend`**: Serves the static HTML/JS/CSS single-page application.
  - **`auth-service`**: Handles all login, registration, and token requests at `/api/auth`.
  - **`user-service`**: Handles all user management requests at `/api/users`.
  - **`device-service`**: Handles all device management requests at `/api/devices`.