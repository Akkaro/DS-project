http:
  # ==========================================
  # ROUTERS - Define URL routing rules
  # ==========================================
  routers:
    # Frontend (Root path)
    frontend:
      rule: "Host(`localhost`)"
      entryPoints:
        - web
      service: frontend

    # User Microservice Routes
    auth-service:
      rule: "Host(`localhost`) && PathPrefix(`/api/auth`)"
      entryPoints:
        - web
      middlewares:
        - strip-api-prefix # Strips /api, so request becomes /auth/**
      service: auth-service

    user-service:
      rule: "Host(`localhost`) && PathPrefix(`/api/users`)"
      entryPoints:
        - web
      middlewares:
        - auth-basic
        - strip-api-prefix
      service: user-service

    # Device Microservice Routes
    device-service:
      rule: "Host(`localhost`) && PathPrefix(`/api/devices`)"
      entryPoints:
        - web
      middlewares:
        - auth-basic
        - strip-api-prefix
      service: device-service

  # ==========================================
  # MIDDLEWARES - Transform and validate requests
  # ==========================================
  middlewares:
    # Basic authentication for API endpoints
    auth-basic:
      basicAuth:
        users:
          - "user:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/"  # password = "test"

    # Remove /api/users prefix before forwarding to microservice
    strip-api-prefix:
      stripPrefix:
        prefixes:
          - "/api"

  # ==========================================
  # SERVICES - Backend endpoints
  # ==========================================
  services:
    frontend:
      loadBalancer:
        servers:
          - url: "http://frontend:80"
          
    auth-service:
      loadBalancer:
        servers:
          - url: "http://auth-service:8082" # Points to new service on its port
        healthCheck:
          path: /api/auth/login # Use the login endpoint as a basic health check
          interval: "30s"
          timeout: "5s"

    user-service:
      loadBalancer:
        servers:
          - url: "http://user-service:8080"
        healthCheck:
          path: /users
          interval: "30s"
          timeout: "5s"

    device-service:
      loadBalancer:
        servers:
          - url: "http://device-service:8080"
        healthCheck:
          path: /devices
          interval: "30s"
          timeout: "5s"