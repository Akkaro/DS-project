version: "3.9"

services:
  # ==========================================
  # DATABASE SERVICES
  # ==========================================
  user-db:
    image: postgres:15
    hostname: user-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: user_db
    ports:
      - "5433:5432"
    volumes:
      - user-db-data:/var/lib/postgresql/data
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

  device-db:
    image: postgres:15
    hostname: device-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: device_db
    ports:
      - "5434:5432"
    volumes:
      - device-db-data:/var/lib/postgresql/data
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

  monitoring-db:
    image: postgres:15
    hostname: monitoring-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: monitoring_db
    ports:
      - "5436:5432"
    volumes:
      - monitoring-db-data:/var/lib/postgresql/data
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

  auth-db:
    image: postgres:15
    hostname: auth-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
      POSTGRES_DB: auth_db
    ports:
      - "5435:5432"
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

  # ==========================================
  # BROKER
  # ==========================================
  rabbitmq:
    image: rabbitmq:3-management
    hostname: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

  # ==========================================
  # MICROSERVICES
  # ==========================================
  user-service:
    image: my-user-service:latest
    build:
      context: ./user_microservice/demo
      dockerfile: ./Dockerfile
    environment:
      - DB_IP=user-db
      - DB_PORT=5432
      - DB_DBNAME=user_db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - PORT=8080
      - SPRING_RABBITMQ_HOST=rabbitmq
    depends_on:
      - user-db
      - rabbitmq
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

  device-service:
    image: my-device-service:latest
    build:
      context: ./device_microservice/demo
      dockerfile: ./Dockerfile
    environment:
      - DB_IP=device-db
      - DB_PORT=5432
      - DB_DBNAME=device_db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - PORT=8080
      - SPRING_RABBITMQ_HOST=rabbitmq
    depends_on:
      - device-db
      - rabbitmq
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

  auth-service:
    image: my-auth-service:latest
    build:
      context: ./auth_microservice/demo
      dockerfile: ./Dockerfile
    environment:
      - DB_IP=auth-db
      - DB_PORT=5432
      - DB_DBNAME=auth_db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - PORT=8082
      - app_user-service_url=http://user-service:8080
    depends_on:
      - auth-db
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

  # ==========================================
  # ASSIGNMENT 3 NEW SERVICES
  # ==========================================
  
  chat-service:
    image: my-chat-service:latest
    build:
      context: ./chat_microservice
    environment:
      - SPRING_RABBITMQ_HOST=rabbitmq
      - PORT=8084
    depends_on:
      - rabbitmq
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

  load-balancer:
    image: my-load-balancer:latest
    build:
      context: ./load_balancer
    environment:
      - SPRING_RABBITMQ_HOST=rabbitmq
      - app.queue.input=sensor.data.queue
      - PORT=8085
    depends_on:
      - rabbitmq
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

  monitoring-service:
    image: my-monitoring-service:latest
    build:
      context: ./monitoring_microservice
    hostname: "monitoring-{{.Task.Slot}}"
    environment:
      - DB_IP=monitoring-db
      - DB_PORT=5432
      - DB_DBNAME=monitoring_db
      - DB_USER=postgres
      - DB_PASSWORD=root
      - SPRING_RABBITMQ_HOST=rabbitmq
      # We remove the hardcoded queue name env var
      - PORT=8083
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
    depends_on:
      - monitoring-db
      - rabbitmq
    networks:
      - ems-network

  # ==========================================
  # FRONTEND & GATEWAY
  # ==========================================
  frontend:
    image: nginx:latest
    container_name: frontend
    restart: always
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

  traefik:
    image: traefik:v3.0
    ports:
      - "8000:80"
      - "8081:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./reverse_proxy/traefik.yml:/etc/traefik/traefik.yml:ro"
      - "./reverse_proxy/dynamic:/etc/traefik/dynamic:ro"
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager

  device-simulator-1:
    image: my-device-simulator:latest
    build:
      context: ./device_simulator
    environment:
      - SPRING_RABBITMQ_HOST=rabbitmq
      # This ID usually hashes to Index 0 (example)
      - DEVICE_ID=74086887-2262-4594-9354-d5d4b68b3510
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

  # Simulator 2 (New)
  device-simulator-2:
    image: my-device-simulator:latest
    # Reuse the same build context/image
    build:
      context: ./device_simulator
    environment:
      - SPRING_RABBITMQ_HOST=rabbitmq
      # Different ID to target a different queue
      - DEVICE_ID=8b2fcd2e-4537-4f9b-be09-a5c3b9c6ae98
    networks:
      - ems-network
    deploy:
      restart_policy:
        condition: on-failure

volumes:
  user-db-data:
  device-db-data:
  auth-db-data:
  monitoring-db-data:

networks:
  ems-network:
    driver: overlay