<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Helper to hide views */
        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">

    <div id="login-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white shadow-lg rounded-xl p-8 w-full max-w-md">
            <h1 class="text-3xl font-bold text-slate-900 mb-6 text-center">Energy Management System</h1>
            <form id="form-login" class="space-y-4">
                <div>
                    <label for="login-username" class="block text-sm font-medium text-slate-600">Username</label>
                    <input type="text" id="login-username" name="username" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-slate-600">Password</label>
                    <input type="password" id="login-password" name="password" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <button type="submit" id="login-submit-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                    Login
                </button>
            </form>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </div>
    </div>

    <div id="admin-view" class="hidden">
        <div class="max-w-7xl mx-auto p-4 md:p-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-slate-900">Admin Dashboard</h1>
                <button id="logout-btn-admin" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-200">
                    Logout
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <div class="space-y-8">
                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h2 class="text-2xl font-semibold mb-4">Create New User</h2>
                        <form id="form-create-user" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="user-username" class="block text-sm font-medium text-slate-600">Username</label>
                                    <input type="text" id="user-username" name="username" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="user-password" class="block text-sm font-medium text-slate-600">Password</label>
                                    <input type="password" id="user-password" name="password" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                            </div>
                            <div>
                                <label for="user-name" class="block text-sm font-medium text-slate-600">Full Name</label>
                                <input type="text" id="user-name" name="name" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="user-email" class="block text-sm font-medium text-slate-600">Email (Optional)</label>
                                <input type="email" id="user-email" name="email" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="user-role" class="block text-sm font-medium text-slate-600">Role</label>
                                <select id="user-role" name="role" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="CLIENT">Client</option>
                                    <option value="ADMIN">Admin</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                                Create User
                            </button>
                        </form>
                    </div>

                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h2 class="text-2xl font-semibold mb-4">All Users</h2>
                        <ul id="list-users" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                            </ul>
                    </div>
                </div>

                <div class="space-y-8">
                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h2 class="text-2xl font-semibold mb-4">Create New Device</h2>
                        <form id="form-create-device" class="space-y-4">
                            <div>
                                <label for="device-name" class="block text-sm font-medium text-slate-600">Device Name</label>
                                <input type="text" id="device-name" name="name" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="device-description" class="block text-sm font-medium text-slate-600">Description</label>
                                <input type="text" id="device-description" name="description" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="device-address" class="block text-sm font-medium text-slate-600">Address</label>
                                <input type="text" id="device-address" name="address" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="device-maxConsumption" class="block text-sm font-medium text-slate-600">Max Consumption (W)</label>
                                    <input type="number" step="0.1" id="device-maxConsumption" name="maxConsumption" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="device-status" class="block text-sm font-medium text-slate-600">Status</label>
                                    <select id="device-status" name="status" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="ACTIVE">Active</option>
                                        <option value="INACTIVE">Inactive</option>
                                        <option value="MAINTENANCE">Maintenance</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition duration-200">
                                Create Device
                            </button>
                        </form>
                    </div>

                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h2 class="text-2xl font-semibold mb-4">Assign Device to User</h2>
                        <form id="form-assign-device" class="space-y-4">
                            <div>
                                <label for="assign-device-id" class="block text-sm font-medium text-slate-600">Select Device</label>
                                <select id="assign-device-id" name="deviceId" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">Loading devices...</option>
                                </select>
                            </div>
                            <div>
                                <label for="assign-user-id" class="block text-sm font-medium text-slate-600">Select User</label>
                                <select id="assign-user-id" name="userId" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">Loading users...</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-200">
                                Assign Device
                            </button>
                        </form>
                    </div>

                    <div class="bg-white shadow-lg rounded-xl p-6">
                        <h2 class="text-2xl font-semibold mb-4">All Devices</h2>
                        <ul id="list-devices" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                            </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="client-view" class="hidden">
        <div class="max-w-4xl mx-auto p-4 md:p-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-slate-900">My Devices</h1>
                <button id="logout-btn-client" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-200">
                    Logout
                </button>
            </div>
            <div class="bg-white shadow-lg rounded-xl p-6">
                <ul id="list-client-devices" class="space-y-4">
                    </ul>
            </div>
        </div>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-semibold">Notification</h3>
                <button id="modal-close-btn" class="text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <p id="modal-message" class="text-slate-700"></p>
        </div>
    </div>

    <div id="chart-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300 z-50">
        <div id="chart-modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 id="chart-device-name" class="text-xl font-semibold text-slate-800">Device Consumption</h3>
                <button id="chart-modal-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>

            <div class="mb-4 flex items-center gap-2">
                <label for="chart-date" class="text-sm font-medium text-slate-600">Select Date:</label>
                <input type="date" id="chart-date" class="border-slate-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>

            <div class="relative h-96 w-full">
                <canvas id="consumptionChart"></canvas>
            </div>
        </div>
    </div>

    <button id="chat-toggle-btn" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition z-50 hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
        </svg>
    </button>

    <div id="chat-window" class="fixed bottom-24 right-6 w-80 bg-white rounded-lg shadow-2xl border border-slate-200 hidden z-50 flex flex-col overflow-hidden font-sans">
        
        <div class="bg-blue-600 text-white p-3">
            <div class="flex justify-between items-center">
                <span class="font-bold">Support Chat</span>
                <button id="chat-close-btn" class="text-blue-100 hover:text-white text-xl leading-none">&times;</button>
            </div>
            
            <div id="chat-header-content" class="mt-2"></div>
        </div>
        
        <div id="chat-messages" class="flex-1 h-64 overflow-y-auto p-3 space-y-2 bg-slate-50 text-sm">
            <div class="text-center text-slate-400 text-xs mt-2">Connecting...</div>
        </div>
        
        <div id="chat-input-area" class="p-3 bg-white border-t flex gap-2">
            <input type="text" id="chat-input" class="flex-1 border border-slate-300 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500" placeholder="Type a message...">
            <button id="chat-send-btn" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">Send</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- API & Auth Configuration ---
            const API_BASE = '/api';
            let accessToken = null;
            let userRole = null;
            let userId = null;
            let username = null; // FIXED: Global variable for chat sender
        
            // --- App-wide State ---
            let allUsers = [];
            let allDevices = [];
            let adminUsersMap = new Map();
            let currentChart = null;
            let currentDeviceId = null;
        
            // --- WebSocket & Chat State ---
            let stompClient = null;
            let chatWithAdmin = false; // false = Bot Mode, true = Admin Mode
            
            // NEW: Admin Chat State
            let activeChatUserId = null; 
            let conversations = new Map(); 
            let unreadCounts = new Map();

            // --- Element Selectors ---
            const loginView = document.getElementById('login-view');
            const adminView = document.getElementById('admin-view');
            const clientView = document.getElementById('client-view');
        
            const loginForm = document.getElementById('form-login');
            const loginError = document.getElementById('login-error');
            const loginButton = document.getElementById('login-submit-btn');
            
            const adminUserForm = document.getElementById('form-create-user');
            const adminUserList = document.getElementById('list-users');
            const adminDeviceForm = document.getElementById('form-create-device');
            const adminDeviceList = document.getElementById('list-devices');
            const adminAssignForm = document.getElementById('form-assign-device');
            const adminAssignDeviceSelect = document.getElementById('assign-device-id');
            const adminAssignUserSelect = document.getElementById('assign-user-id');
            const adminLogoutBtn = document.getElementById('logout-btn-admin');
        
            const clientDeviceList = document.getElementById('list-client-devices');
            const clientLogoutBtn = document.getElementById('logout-btn-client');
        
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalContent = document.getElementById('modal-content');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');
        
            // Chat Selectors
            const chatWindow = document.getElementById('chat-window');
            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
        
            // --- View Management ---
            function showView(viewId) {
                loginView.classList.add('hidden');
                adminView.classList.add('hidden');
                clientView.classList.add('hidden');
                
                const view = document.getElementById(viewId);
                if (view) {
                    view.classList.remove('hidden');
                }
            }
        
            // --- Auth & Token Functions ---
        
            function parseJwt(token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    return JSON.parse(jsonPayload);
                } catch (e) {
                    console.error('Failed to parse JWT', e);
                    return null;
                }
            }
        
            function handleLogout() {
                accessToken = null;
                userRole = null;
                userId = null;
                username = null;
                allUsers = [];
                allDevices = [];
                adminUsersMap.clear();
                
                if (stompClient && stompClient.connected) return;

                if (stompClient) {
                    stompClient.disconnect();
                    stompClient = null;
                }
                chatWindow.classList.add('hidden');
                chatToggleBtn.classList.add('hidden');
                
                showView('login-view');
            }
        
            async function handleLogin(e) {
                e.preventDefault();
                loginError.textContent = '';
                loginButton.disabled = true;
                loginButton.textContent = 'Logging in...';
            
                // Update global username variable
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
            
                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                
                    if (!response.ok) {
                        throw new Error('Invalid username or password.');
                    }
                
                    const data = await response.json();
                    accessToken = data.accessToken;
                    
                    const tokenData = parseJwt(accessToken);
                    if (!tokenData) {
                        throw new Error('Invalid token received.');
                    }
                    
                    userRole = tokenData.role;
                    userId = tokenData.userId;
                    
                    loginForm.reset();
                
                    // Connect to WebSocket after successful login
                    connectWebSocket();
                    
                    setupChatUI();
                    
                    if (userRole === 'ADMIN') {
                        showView('admin-view');
                        loadAdminData();
                    } else if (userRole === 'CLIENT') {
                        showView('client-view');
                        loadClientData();
                    } else {
                        throw new Error('Unknown user role.');
                    }
                
                } catch (error) {
                    loginError.textContent = error.message;
                } finally {
                    loginButton.disabled = false;
                    loginButton.textContent = 'Login';
                }
            }
            
            // --- UI Setup Logic ---
            function setupChatUI() {
                const headerContent = document.getElementById('chat-header-content');
                const chatMessages = document.getElementById('chat-messages');
                const inputArea = document.getElementById('chat-input-area');
                
                // Clear header to prevent duplicates
                headerContent.innerHTML = '';

                if (userRole === 'ADMIN') {
                    // ADMIN VIEW
                    // 1. Hide Input initially
                    inputArea.classList.add('hidden');
                    
                    // 2. Set default message
                    chatMessages.innerHTML = '<div class="text-center text-slate-400 text-xs mt-2">Waiting for client messages...</div>';
                    
                    // 3. Add Back Button (Hidden by default)
                    headerContent.innerHTML = `<button id="btn-back-inbox" class="w-full py-1 rounded bg-blue-700 text-white text-xs font-bold hidden hover:bg-blue-800 transition">← Back to Inbox</button>`;
                    
                    // 4. Bind Back Button Event
                    document.getElementById('btn-back-inbox').addEventListener('click', renderAdminInbox);
                    
                    // 5. Render Inbox
                    renderAdminInbox();

                } else {
                    // CLIENT VIEW
                    // 1. Show Input
                    inputArea.classList.remove('hidden');

                    // 2. Inject Bot/Admin Toggles
                    headerContent.innerHTML = `
                        <div class="flex bg-blue-700 rounded p-1 text-xs">
                            <button id="mode-bot" class="flex-1 py-1 rounded bg-white text-blue-800 font-semibold shadow transition">Bot (AI)</button>
                            <button id="mode-admin" class="flex-1 py-1 rounded text-blue-100 hover:text-white transition">Admin</button>
                        </div>`;
                    
                    // 3. Bind Events dynamically (NOW IT IS SAFE)
                    document.getElementById('mode-bot').addEventListener('click', () => setClientChatMode(false));
                    document.getElementById('mode-admin').addEventListener('click', () => setClientChatMode(true));
                    
                    // 4. Set Default State
                    setClientChatMode(false); 
                }
            }

            // --- CLIENT Logic ---
            function setClientChatMode(isAdmin) {
                chatWithAdmin = isAdmin;
                const btnBot = document.getElementById('mode-bot');
                const btnAdmin = document.getElementById('mode-admin');
                
                // Safety check in case elements aren't in DOM yet
                if (!btnBot || !btnAdmin) return;

                if (isAdmin) {
                    // Admin Active
                    btnAdmin.className = "flex-1 py-1 rounded bg-white text-blue-800 font-semibold shadow transition";
                    btnBot.className = "flex-1 py-1 rounded text-blue-100 hover:text-white transition";
                    appendSystemLog("Switched to Admin Chat.");
                } else {
                    // Bot Active
                    btnBot.className = "flex-1 py-1 rounded bg-white text-blue-800 font-semibold shadow transition";
                    btnAdmin.className = "flex-1 py-1 rounded text-blue-100 hover:text-white transition";
                    appendSystemLog("Switched to Support Bot.");
                }
            }

            // --- ADMIN Incoming Message Logic ---
            function handleAdminIncoming(msg) {
                try {
                    const body = JSON.parse(msg.body);
                    
                    // 1. Ignore my own messages (echo prevention)
                    if (body.sender === 'Admin') return;

                    const clientID = body.userId;
                    
                    // 2. Initialize conversation if it doesn't exist
                    if (!conversations.has(clientID)) {
                        conversations.set(clientID, { name: body.sender, msgs: [] });
                    }
                    
                    // 3. Add message to local history
                    const conversation = conversations.get(clientID);
                    conversation.msgs.push({ 
                        sender: body.sender, 
                        content: body.content, 
                        align: 'left' 
                    });

                    // 4. Update UI
                    if (activeChatUserId === clientID) {
                        // If I am currently chatting with this user, show the message immediately
                        appendMessage(body.sender, body.content, 'left'); 
                    } else {
                        // Otherwise, increment unread count
                        const currentCount = unreadCounts.get(clientID) || 0;
                        unreadCounts.set(clientID, currentCount + 1);
                        
                        // If I am looking at the inbox, refresh it to show the unread badge
                        if (!activeChatUserId) {
                            renderAdminInbox(); 
                        }
                    }
                } catch(e) { 
                    console.error("Error handling incoming admin message:", e); 
                }
            }

            // --- Admin Inbox Logic ---
            function renderAdminInbox() {
                activeChatUserId = null; 
                
                // Hide Back Button & Input Area
                document.getElementById('btn-back-inbox').classList.add('hidden');
                document.getElementById('chat-input-area').classList.add('hidden'); 
                
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = ''; 

                if (conversations.size === 0) {
                    chatMessages.innerHTML = '<div class="text-center text-slate-400 text-xs mt-4">No active conversations.</div>';
                    return;
                }

                const list = document.createElement('div');
                list.className = "space-y-2";

                conversations.forEach((data, cId) => {
                    const unread = unreadCounts.get(cId) || 0;
                    const item = document.createElement('div');
                    item.className = "p-3 bg-slate-100 rounded cursor-pointer hover:bg-blue-50 flex justify-between items-center transition";
                    item.innerHTML = `
                        <div class="font-semibold text-sm text-slate-800">${data.name || 'Client'}</div>
                        ${unread > 0 ? `<span class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full shadow-sm">${unread}</span>` : '<span class="text-xs text-slate-400">Open</span>'}
                    `;
                    item.onclick = () => openAdminChat(cId);
                    list.appendChild(item);
                });

                chatMessages.appendChild(list);
            }

            function openAdminChat(cId) {
                activeChatUserId = cId;
                unreadCounts.set(cId, 0); 
                
                // Show Back Button & Input Area
                document.getElementById('btn-back-inbox').classList.remove('hidden');
                document.getElementById('chat-input-area').classList.remove('hidden'); 
                
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = ''; 

                const history = conversations.get(cId)?.msgs || [];
                history.forEach(m => appendMessage(m.sender, m.content, m.align));
            }
        
            function connectWebSocket() {
                // Prevent double connections
                if (stompClient && stompClient.connected) return;

                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.debug = null;

                stompClient.connect({}, () => {
                    console.log('Connected to WebSocket');
                
                    /* ----------------------------------
                       CLIENT: personal topic
                    ---------------------------------- */
                    if (userRole === 'CLIENT') {
                        const userTopic = `/topic/user/${userId}`;
                    
                        stompClient.subscribe(userTopic, (msg) => {
                            // Notifications (plain text)
                            if (msg.body.startsWith("NOTIFICATION:")) {
                                const text = msg.body.replace("NOTIFICATION: ", "");
                                showModal("System Alert", text, true);
                                return;
                            }
                        
                            // Chat message (JSON)
                            try {
                                const body = JSON.parse(msg.body);
                                if (body.sender && body.content) {
                                    appendMessage(body.sender, body.content, 'left');
                                }
                            } catch (e) {
                                console.error("Invalid message:", msg.body);
                            }
                        });
                    }
                
                    /* ----------------------------------
                       ADMIN: global inbox topic
                    ---------------------------------- */
                    if (userRole === 'ADMIN') {
                        stompClient.subscribe('/topic/admin', (msg) => {
                            try {
                                handleAdminIncoming(msg);
                            } catch (e) {
                                console.error("Admin message error:", e);
                            }
                        });
                    }
                
                    // Show chat toggle once connected
                    chatToggleBtn.classList.remove('hidden');
                
                }, (error) => {
                    console.error('WebSocket Error:', error);
                });
            }

            function sendMessage() {
                const content = chatInput.value.trim();
                if (!content || !stompClient || !stompClient.connected) return;
            
                let chatMessage;
            
                /* ----------------------------------
                   CLIENT → ADMIN
                ---------------------------------- */
                if (userRole === 'CLIENT') {
                    chatMessage = {
                        sender: username,
                        content: content,
                        userId: userId              // sender (client) ID
                    };
                }
            
                /* ----------------------------------
                   ADMIN → CLIENT
                ---------------------------------- */
                if (userRole === 'ADMIN') {
                    if (!activeChatUserId) {
                        alert("Select a client first");
                        return;
                    }
                
                    chatMessage = {
                        sender: 'Admin',
                        content: content,
                        targetUserId: activeChatUserId   // receiver (client) ID
                    };
                }
            
                // Send message
                stompClient.send("/app/chat", {}, JSON.stringify(chatMessage));
            
                // Show message instantly in UI
                appendMessage("Me", content, 'right');
            
                chatInput.value = '';
            }

        
            function appendMessage(sender, text, align) {
                const div = document.createElement('div');
                div.className = `max-w-[80%] p-2 rounded-lg text-sm mb-2 ${
                    align === 'right' 
                    ? 'bg-blue-100 text-blue-900 ml-auto rounded-br-none' 
                    : 'bg-white border border-slate-200 text-slate-800 mr-auto rounded-bl-none'
                }`;
                div.innerHTML = `<div class="font-bold opacity-75 text-xs mb-1">${sender}</div><div>${text}</div>`;
                chatMessages.appendChild(div);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        
            function appendSystemLog(text) {
                const div = document.createElement('div');
                div.className = "text-center text-slate-400 text-xs my-2 italic";
                div.innerText = text;
                chatMessages.appendChild(div);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        
            // --- Chat Event Listeners ---
            chatToggleBtn.addEventListener('click', () => chatWindow.classList.toggle('hidden'));
            document.getElementById('chat-close-btn').addEventListener('click', () => chatWindow.classList.add('hidden'));
            document.getElementById('chat-send-btn').addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
        
            // --- API Fetch Wrapper ---
            async function fetchApi(url, options = {}) {
                const headers = {
                    ...options.headers,
                    'Content-Type': 'application/json',
                };
                
                if (accessToken) {
                    headers['Authorization'] = `Bearer ${accessToken}`;
                }
            
                const response = await fetch(url, { ...options, headers });
            
                if (response.status === 401 || response.status === 403) {
                    handleLogout();
                    throw new Error('Unauthorized');
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Network error: ${response.statusText}`);
                }
                
                if (response.status === 201 || response.status === 204) {
                    return null;
                }
            
                return await response.json();
            }
        
            // --- Modal Helper Functions ---
            function showModal(title, message, isError = false) {
                modalTitle.textContent = title;
                modalMessage.innerHTML = message;
                modalContent.classList.toggle('border-l-4', isError);
                modalContent.classList.toggle('border-red-500', isError);
                modalContent.classList.toggle('border-green-500', !isError);
            
                modalBackdrop.classList.remove('opacity-0', 'pointer-events-none');
                modalContent.classList.remove('scale-95', 'opacity-0');
            }
        
            function hideModal() {
                modalBackdrop.classList.add('opacity-0', 'pointer-events-none');
                modalContent.classList.add('scale-95', 'opacity-0');
            }
            modalCloseBtn.addEventListener('click', hideModal);
            modalBackdrop.addEventListener('click', (e) => {
                if (e.target === modalBackdrop) hideModal();
            });
        
        
            // --- ADMIN VIEW: Data Loading and Rendering ---
            
            async function loadAdminData() {
                try {
                    [allUsers, allDevices] = await Promise.all([
                        fetchApi(`${API_BASE}/users`),
                        fetchApi(`${API_BASE}/devices`)
                    ]);
                
                    adminUsersMap = new Map(allUsers.map(u => [u.id, u.name]));
                
                    renderAdminUserList(allUsers);
                    renderAdminDeviceList(allDevices, adminUsersMap);
                    populateAdminDropdowns(allUsers, allDevices);
                } catch (error) {
                    console.error('Failed to load admin data:', error);
                    if (error.message !== 'Unauthorized') {
                        showModal('Error', 'Failed to load admin data.', true);
                    }
                }
            }
            
            function renderAdminUserList(users) {
                adminUserList.innerHTML = '';
                if (!users || users.length === 0) {
                    adminUserList.innerHTML = '<li class="text-slate-500">No users found.</li>';
                    return;
                }
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-50 p-3 rounded-lg shadow-sm';
                    li.innerHTML = `
                        <div>
                            <span class="font-semibold text-slate-900">${user.name}</span>
                            <span class="text-sm text-slate-600 ml-2">(${user.username}) - ${user.role}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${user.id}" class="update-user-btn text-blue-500 hover:text-blue-700 font-medium">Update</button>
                            <button data-id="${user.id}" class="delete-user-btn text-red-500 hover:text-red-700 font-medium">Delete</button>
                        </div>
                    `;
                    adminUserList.appendChild(li);
                });
            }
        
            function renderAdminDeviceList(devices, usersMap) {
                adminDeviceList.innerHTML = '';
                if (!devices || devices.length === 0) {
                    adminDeviceList.innerHTML = '<li class="text-slate-500">No devices found.</li>';
                    return;
                }
                devices.forEach(device => {
                    const assignedUserName = device.userId ? usersMap.get(device.userId) || 'Unknown User' : 'Unassigned';
                    const userColor = device.userId ? 'text-blue-600' : 'text-slate-500';
                    
                    const unassignButton = device.userId ? 
                        `<button data-id="${device.id}" class="unassign-device-btn text-yellow-600 hover:text-yellow-800 font-medium">Unassign</button>` : '';
                
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-50 p-3 rounded-lg shadow-sm';
                    li.innerHTML = `
                        <div>
                            <span class="font-semibold text-slate-900">${device.name}</span>
                            <span class="text-sm ${userColor} ml-2">(${assignedUserName})</span>
                        </div>
                        <div class="flex space-x-2">
                            ${unassignButton}
                            <button data-id="${device.id}" class="update-device-btn text-blue-500 hover:text-blue-700 font-medium">Update</button>
                            <button data-id="${device.id}" class="delete-device-btn text-red-500 hover:text-red-700 font-medium">Delete</button>
                        </div>
                    `;
                    adminDeviceList.appendChild(li);
                });
            }
        
            function populateAdminDropdowns(users, devices) {
                adminAssignUserSelect.innerHTML = '<option value="">Select a user</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${user.username})`;
                    adminAssignUserSelect.appendChild(option);
                });
            
                const unassignedDevices = devices.filter(d => !d.userId);
                adminAssignDeviceSelect.innerHTML = '<option value="">Select an unassigned device</option>';
                unassignedDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.textContent = device.name;
                    adminAssignDeviceSelect.appendChild(option);
                });
            }
        
            // --- CLIENT VIEW: Data Loading and Rendering ---
            async function loadClientData() {
                if (!userId) {
                    handleLogout();
                    return;
                }
                try {
                    const devices = await fetchApi(`${API_BASE}/devices/user/${userId}`);
                    renderClientDeviceList(devices);
                } catch (error) {
                    console.error('Failed to load client data:', error);
                    if (error.message !== 'Unauthorized') {
                        showModal('Error', 'Failed to load your devices.', true);
                    }
                }
            }
        
            function renderClientDeviceList(devices) {
                clientDeviceList.innerHTML = '';
                if (!devices || devices.length === 0) {
                    clientDeviceList.innerHTML = '<li class="text-slate-500 p-4 text-center">You have no devices assigned to your account.</li>';
                    return;
                }
                devices.forEach(device => {
                    const statusColor = device.status === 'ACTIVE' ? 'text-green-600' : 'text-slate-500';
                    const li = document.createElement('li');
                    li.className = 'flex flex-col md:flex-row justify-between md:items-center bg-slate-50 p-4 rounded-lg shadow-sm';
                    li.innerHTML = `
                        <div>
                            <span class="font-semibold text-lg text-slate-900">${device.name}</span>
                            <p class="text-sm text-slate-600">${device.description || 'No description'}</p>
                            <p class="text-sm text-slate-600">${device.address || 'No address'}</p>
                        </div>
                        <div class="mt-2 md:mt-0 md:text-right flex flex-col items-end gap-2">
                            <span class="font-medium ${statusColor} capitalize">${(device.status || 'unknown').toLowerCase()}</span>
                            <p class="text-sm text-slate-500">Max: ${device.maxConsumption} W</p>
                            <button class="view-chart-btn bg-blue-100 text-blue-600 hover:bg-blue-200 px-3 py-1 rounded text-sm font-medium transition" 
                                    data-id="${device.id}" data-name="${device.name}">
                                View Consumption
                            </button>
                        </div>
                    `;
                    clientDeviceList.appendChild(li);
                });
            
                document.querySelectorAll('.view-chart-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const name = e.target.dataset.name;
                        openChartModal(id, name);
                    });
                });
            }
            
            // --- Update Modal Functions ---
        
            function showUpdateUserModal(user) {
                const formHtml = `
                    <form id="form-update-user" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="update-user-username" class="block text-sm font-medium text-slate-600">Username</label>
                                <input type="text" id="update-user-username" name="username" required value="${user.username}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="update-user-password" class="block text-sm font-medium text-slate-600">Password</label>
                                <input type="password" id="update-user-password" name="password" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Leave blank to keep unchanged">
                            </div>
                        </div>
                        <div>
                            <label for="update-user-name" class="block text-sm font-medium text-slate-600">Full Name</label>
                            <input type="text" id="update-user-name" name="name" required value="${user.name}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="update-user-email" class="block text-sm font-medium text-slate-600">Email</label>
                            <input type="email" id="update-user-email" name="email" value="${user.email || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="update-user-role" class="block text-sm font-medium text-slate-600">Role</label>
                            <select id="update-user-role" name="role" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="CLIENT" ${user.role === 'CLIENT' ? 'selected' : ''}>Client</option>
                                <option value="ADMIN" ${user.role === 'ADMIN' ? 'selected' : ''}>Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                            Save Changes
                        </button>
                    </form>
                `;
                
                showModal(`Update User: ${user.name}`, formHtml);
                
                document.getElementById('form-update-user').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());
                
                    if (!data.password) {
                        data.password = null;
                    }
                    
                    try {
                        await fetchApi(`${API_BASE}/users/${user.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(data)
                        });
                        hideModal();
                        showModal('Success', 'User updated successfully!');
                        loadAdminData();
                    } catch (error) {
                        showModal('Error', error.message, true);
                    }
                });
            }
            
            const chartModalBackdrop = document.getElementById('chart-modal-backdrop');
            const chartModalContent = document.getElementById('chart-modal-content');
            const chartDateInput = document.getElementById('chart-date');
            const chartCloseBtn = document.getElementById('chart-modal-close-btn');
                    
            function openChartModal(deviceId, deviceName) {
                currentDeviceId = deviceId;
                document.getElementById('chart-device-name').textContent = `Consumption: ${deviceName}`;
            
                chartDateInput.valueAsDate = new Date();
            
                chartModalBackdrop.classList.remove('opacity-0', 'pointer-events-none');
                chartModalContent.classList.remove('scale-95', 'opacity-0');
            
                fetchAndRenderChart();
            }
            
            function closeChartModal() {
                chartModalBackdrop.classList.add('opacity-0', 'pointer-events-none');
                chartModalContent.classList.add('scale-95', 'opacity-0');
            }
            
            async function fetchAndRenderChart() {
                if (!currentDeviceId) return;
                const date = chartDateInput.value;
            
                try {
                    const response = await fetch(`${API_BASE}/monitoring/consumption/${currentDeviceId}?date=${date}`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                
                    if (!response.ok) throw new Error("Failed to load chart data");
                    const data = await response.json();
                
                    renderChart(data);
                } catch (error) {
                    console.error(error);
                    alert("Could not load consumption data.");
                }
            }
            
            function renderChart(data) {
                const ctx = document.getElementById('consumptionChart').getContext('2d');
            
                if (currentChart) {
                    currentChart.destroy();
                }
            
                const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
                const values = new Array(24).fill(0);
            
                data.forEach(record => {
                    const hour = new Date(record.timestamp).getHours();
                    values[hour] = record.totalConsumption;
                });
            
                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: hours,
                        datasets: [{
                            label: 'Energy Consumption (kWh)',
                            data: values,
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            chartCloseBtn.addEventListener('click', closeChartModal);
            chartModalBackdrop.addEventListener('click', (e) => {
                if (e.target === chartModalBackdrop) closeChartModal();
            });
            chartDateInput.addEventListener('change', fetchAndRenderChart);
        
            function showUpdateDeviceModal(device) {
                const formHtml = `
                    <form id="form-update-device" class="space-y-4">
                        <div>
                            <label for="update-device-name" class="block text-sm font-medium text-slate-600">Device Name</label>
                            <input type="text" id="update-device-name" name="name" required value="${device.name}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="update-device-description" class="block text-sm font-medium text-slate-600">Description</label>
                            <input type="text" id="update-device-description" name="description" value="${device.description || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="update-device-address" class="block text-sm font-medium text-slate-600">Address</label>
                            <input type="text" id="update-device-address" name="address" value="${device.address || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="update-device-maxConsumption" class="block text-sm font-medium text-slate-600">Max Consumption (W)</label>
                                <input type="number" step="0.1" id="update-device-maxConsumption" name="maxConsumption" required value="${device.maxConsumption}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="update-device-status" class="block text-sm font-medium text-slate-600">Status</label>
                                <select id="update-device-status" name="status" required class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="ACTIVE" ${device.status === 'ACTIVE' ? 'selected' : ''}>Active</option>
                                    <option value="INACTIVE" ${device.status === 'INACTIVE' ? 'selected' : ''}>Inactive</option>
                                    <option value="MAINTENANCE" ${device.status === 'MAINTENANCE' ? 'selected' : ''}>Maintenance</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition duration-200">
                            Save Changes
                        </button>
                    </form>
                `;
                
                showModal(`Update Device: ${device.name}`, formHtml);
                
                document.getElementById('form-update-device').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());
                    data.maxConsumption = parseFloat(data.maxConsumption);
                    data.userId = device.userId;
                
                    try {
                        await fetchApi(`${API_BASE}/devices/${device.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(data)
                        });
                        hideModal();
                        showModal('Success', 'Device updated successfully!');
                        loadAdminData();
                    } catch (error) {
                        showModal('Error', error.message, true);
                    }
                });
            }
        
        
            loginForm.addEventListener('submit', handleLogin);
            adminLogoutBtn.addEventListener('click', handleLogout);
            clientLogoutBtn.addEventListener('click', handleLogout);
        
            // --- ADMIN Event Listeners (Forms) ---
            adminUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(adminUserForm);
                const data = Object.fromEntries(formData.entries());
            
                try {
                    await fetchApi(`${API_BASE}/auth/register`, {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showModal('Success', 'User created successfully!');
                    adminUserForm.reset();
                    setTimeout(loadAdminData, 500);
                } catch (error) {
                    showModal('Error', error.message, true);
                }
            });
        
            adminDeviceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(adminDeviceForm);
                const data = Object.fromEntries(formData.entries());
                data.maxConsumption = parseFloat(data.maxConsumption);
            
                try {
                    await fetchApi(`${API_BASE}/devices`, {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showModal('Success', 'Device created successfully!');
                    adminDeviceForm.reset();
                    loadAdminData();
                } catch (error) {
                    showModal('Error', error.message, true);
                }
            });
        
            adminAssignForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const deviceId = adminAssignDeviceSelect.value;
                const userId = adminAssignUserSelect.value;
            
                if (!deviceId || !userId) {
                    showModal('Warning', 'Please select both a device and a user.', true);
                    return;
                }
            
                try {
                    await fetchApi(`${API_BASE}/devices/${deviceId}/assign/${userId}`, { method: 'PUT' });
                    showModal('Success', 'Device assigned successfully!');
                    adminAssignForm.reset();
                    loadAdminData();
                } catch (error) {
                    showModal('Error', error.message, true);
                }
            });
        
            // --- ADMIN Event Listeners (Event Delegation for Lists) ---
            adminUserList.addEventListener('click', async (e) => {
                const target = e.target;
                const userId = target.dataset.id;
            
                if (target.classList.contains('delete-user-btn')) {
                    if (!confirm('Are you sure you want to delete this user?')) return;
                    try {
                        await fetchApi(`${API_BASE}/auth/user/${userId}`, { method: 'DELETE' });
                        showModal('Success', 'User deleted successfully.');
                        setTimeout(loadAdminData, 500);
                    } catch (error) {
                        showModal('Error', error.message, true);
                    }
                }
            
                if (target.classList.contains('update-user-btn')) {
                    const user = allUsers.find(u => u.id === userId);
                    if (user) {
                        showUpdateUserModal(user);
                    }
                }
            });
        
            adminDeviceList.addEventListener('click', async (e) => {
                const target = e.target;
                const deviceId = target.dataset.id;
            
                if (target.classList.contains('delete-device-btn')) {
                    if (!confirm('Are you sure you want to delete this device?')) return;
                    try {
                        await fetchApi(`${API_BASE}/devices/${deviceId}`, { method: 'DELETE' });
                        showModal('Success', 'Device deleted successfully.');
                        loadAdminData();
                    } catch (error) {
                        showModal('Error', error.message, true);
                    }
                }
                
                if (target.classList.contains('update-device-btn')) {
                    const device = allDevices.find(d => d.id === deviceId);
                    if (device) {
                        showUpdateDeviceModal(device);
                    }
                }
            
                if (target.classList.contains('unassign-device-btn')) {
                    if (!confirm('Are you sure you want to unassign this device?')) return;
                    try {
                        await fetchApi(`${API_BASE}/devices/${deviceId}/unassign`, { method: 'PUT' });
                        showModal('Success', 'Device unassigned successfully.');
                        loadAdminData();
                    } catch (error) {
                        showModal('Error', error.message, true);
                    }
                }
            });
        
            showView('login-view');
        });
    </script>
</body>
</html>